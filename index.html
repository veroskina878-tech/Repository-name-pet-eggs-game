<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Pet Eggs ‚Äî Final</title>
<link rel="manifest" href="/manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Pet Eggs">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
:root{
  --bg1:#061028; --bg2:#08142a; --card:#0f1630; --accent1:#6e7bff; --accent2:#b57bff; --soft:#e6e9ff;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,system-ui;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--soft);-webkit-font-smoothing:antialiased}
.topbar{position:fixed;left:0;right:0;top:0;height:56px;display:flex;align-items:center;justify-content:space-between;padding:6px 12px;z-index:50}
.brand{font-weight:700}
.controls{display:flex;gap:8px;align-items:center}
.iconBtn{background:linear-gradient(145deg,var(--accent1),var(--accent2));border:none;color:white;padding:8px 12px;border-radius:12px;font-weight:700}
.iconGhost{background:rgba(255,255,255,0.03);border:none;color:var(--soft);padding:8px 10px;border-radius:10px}
.container{display:flex;height:100vh;padding-top:56px;gap:12px}
.col{padding:12px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.03));box-shadow:inset 0 -8px 30px rgba(0,0,0,0.5)}
.left,.right{width:28%;overflow:auto}
.center{width:44%;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative}
.eggCard{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:12px;margin-bottom:12px;background:linear-gradient(135deg,rgba(255,255,255,0.02),rgba(0,0,0,0.03))}
.eggIcon{width:84px;height:84px;border-radius:16px;display:flex;align-items:center;justify-content:center;background:linear-gradient(145deg,rgba(255,255,255,0.02),rgba(0,0,0,0.04));box-shadow:0 12px 30px rgba(0,0,0,0.5)}
.buyBtn{background:linear-gradient(145deg,#4f60ff,#9a7bff);border:none;color:white;padding:10px 14px;border-radius:12px;font-weight:700}
.stat{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);margin-bottom:12px}
.centerCoin{width:180px;height:180px;border-radius:999px;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle at 30% 30%, rgba(255,220,100,0.18), rgba(255,195,80,0.06));box-shadow:0 20px 60px rgba(0,0,0,0.6);transform-style:preserve-3d}
.coinImg{width:110px;animation:coinSpin 3s linear infinite}
@keyframes coinSpin{from{transform:rotateY(0deg) rotateZ(0deg)}to{transform:rotateY(360deg) rotateZ(10deg)}}
.centerCoin.pulse{animation:float 4s ease-in-out infinite}
@keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-10px)}100%{transform:translateY(0)}}
.bottomBar{position:fixed;left:28%;right:28%;bottom:10px;padding:10px;border-radius:12px;background:linear-gradient(180deg,rgba(0,0,0,0.25),rgba(0,0,0,0.35));display:flex;align-items:center;justify-content:space-between;gap:12px;z-index:40}
.small{font-size:13px;opacity:.95}
.pulseGlow{animation:pulseGlow 2.5s infinite}
@keyframes pulseGlow{0%{box-shadow:0 12px 30px rgba(110,123,255,0.06)}50%{box-shadow:0 20px 50px rgba(110,123,255,0.12)}100%{box-shadow:0 12px 30px rgba(110,123,255,0.06)}}

/* overlays */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:60}
.modal{width:94%;max-width:900px;background:#0d1831;border-radius:16px;padding:18px;color:var(--soft);box-shadow:0 20px 60px rgba(0,0,0,0.6);max-height:86vh;overflow:auto}
.row{display:flex;gap:10px;align-items:center}
.galleryList{display:flex;flex-direction:column;gap:12px;padding-right:8px}
.galleryTile{display:flex;gap:12px;align-items:center;padding:10px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03))}
.pet3d{width:96px;height:96px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:40px;transform-style:preserve-3d;animation:spinY 6s linear infinite}
@keyframes spinY{from{transform:rotateY(0)}to{transform:rotateY(360deg)}}
.glowGold{box-shadow:0 8px 28px rgba(255,200,80,0.28),0 0 60px rgba(255,200,80,0.08)}
.locked{opacity:.5}
.achItem{padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));margin-bottom:8px}
canvas{width:100%;height:160px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:8px;padding:6px}
.priceAbbr{font-weight:700}
@media (max-width:900px){ .container{flex-direction:column;padding-top:56px} .left,.right,.center{width:100%} .bottomBar{left:8px;right:8px} }
</style>
</head>
<body>

<div class="topbar">
  <div class="brand">Pet Eggs ‚Äî Final</div>
  <div class="controls">
    <button id="btnAnalytics" class="iconGhost">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
    <button id="btnGallery" class="iconBtn">üñº –ì–∞–ª–µ—Ä–µ—è</button>
    <button id="btnSettings" class="iconGhost">‚öôÔ∏è</button>
  </div>
</div>

<div class="container">
  <div class="col left" id="leftCol">
    <h3>üõí –ú–∞–≥–∞–∑–∏–Ω ‚Äî –±—É—Å—Ç–µ—Ä—ã</h3>
    <div id="shopList"></div>

    <h3>üîß –£–¥–∞—á–∞</h3>
    <div class="stat">
      <div id="luckInfo">üçÄ –£–¥–∞—á–∞: 0</div>
      <div style="margin-top:8px">
        <button id="buyLuckBtn" class="buyBtn">–ö—É–ø–∏—Ç—å —É–¥–∞—á—É</button>
        <span id="luckPrice" style="margin-left:8px" class="priceAbbr"></span>
      </div>
    </div>

    <h3>üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>
    <div id="achPreview"></div>

    <h3 style="margin-top:14px">‚öôÔ∏è –≠–∫—Å–ø–æ—Ä—Ç / –∏–º–ø–æ—Ä—Ç</h3>
    <div style="display:flex;gap:8px;flex-direction:column">
      <button id="exportBtn" class="iconGhost">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</button>
      <input id="importFile" type="file" accept=".json" style="display:none"/>
      <button id="importBtn" class="iconGhost">‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</button>
    </div>
  </div>

  <div class="col center" id="centerCol">
    <div class="centerCoin pulseGlow" id="coinWrap">
      <img id="coinImg" class="coinImg" src="" alt="coin"/>
    </div>
    <div style="margin-top:14px">
      <div style="display:flex;gap:8px">
        <select id="eggSelect" style="padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);color:var(--soft)">
        </select>
        <button id="buyEggBtn" class="buyBtn">–ö—É–ø–∏—Ç—å —è–π—Ü–æ</button>
      </div>
    </div>

    <div id="animLayer" style="position:absolute;left:0;right:0;top:0;bottom:0;pointer-events:none"></div>
  </div>

  <div class="col right" id="rightCol">
    <h3>ü•ö –ë—ã—Å—Ç—Ä–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ</h3>
    <div id="quickEggs"></div>

    <h3 style="margin-top:14px">üìà –ü—Ä–æ–≥—Ä–µ—Å—Å</h3>
    <div id="chartWrap" class="stat">
      <canvas id="chart"></canvas>
    </div>
    <div id="analyticStats"></div>
  </div>
</div>

<div class="bottomBar">
  <div style="display:flex;gap:12px;align-items:center">
    <div id="moneyDisplay" class="small priceAbbr">üí∞ 0</div>
    <div id="perSec" class="small">‚ö° 0 / —Å–µ–∫</div>
  </div>
  <div style="display:flex;flex-direction:column;align-items:center">
    <div id="lastDrop" class="small">üêæ –ü–æ—Å–ª–µ–¥–Ω–∏–π: ‚Äî</div>
    <div id="boosterTimer" class="small" style="margin-top:4px"></div>
  </div>
</div>

<!-- SETTINGS modal -->
<div id="settingsModal" class="overlay">
  <div class="modal">
    <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
    <div class="row" style="margin-top:8px">
      <label style="width:120px">–ì—Ä–æ–º–∫–æ—Å—Ç—å</label>
      <input id="volumeRange" type="range" min="0" max="1" step="0.01" value="0.6" style="flex:1"/>
    </div>
    <div class="row" style="margin-top:12px">
      <label style="width:120px">–ó–≤—É–∫</label>
      <button id="toggleSound" class="iconGhost">–í–∫–ª/–í—ã–∫–ª</button>
    </div>
    <div style="margin-top:14px;display:flex;justify-content:flex-end">
      <button id="closeSettings" class="iconBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<!-- Analytics modal (reused) -->
<div id="analyticsModal" class="overlay">
  <div class="modal">
    <h3>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h3>
    <canvas id="chartModal" style="width:100%;height:200px"></canvas>
    <div id="statsBlock" style="margin-top:12px"></div>
    <div style="margin-top:12px;text-align:right">
      <button id="closeAnalytics" class="iconBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<!-- Gallery modal -->
<div id="galleryModal" class="overlay">
  <div class="modal">
    <h3>üñº –ì–∞–ª–µ—Ä–µ—è –ø–∏—Ç–æ–º—Ü–µ–≤</h3>
    <div id="galleryList" class="galleryList"></div>
    <div style="margin-top:12px;text-align:right"><button id="closeGallery" class="iconBtn">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  </div>
</div>

<script>
/* ============================
   Utilities & data
   ============================ */
const SAVE_KEY = 'pet_eggs_final_v2';
function fmt(n){
  if(!isFinite(n)) return 0;
  if(n>=1e9) return (n/1e9).toFixed(2).replace(/\.00$/,'')+' –º–ª—Ä–¥';
  if(n>=1e6) return (n/1e6).toFixed(2).replace(/\.00$/,'')+' –º–ª–Ω';
  if(n>=1e3) return (n/1e3).toFixed(2).replace(/\.00$/,'')+' —Ç—ã—Å.';
  return Math.floor(n);
}

/* create svg eggs/pets as data URIs ‚Äî more detailed */
function eggSVGDataURI(color1, color2, accent){
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='256' height='256'>
    <defs>
      <radialGradient id='g' cx='30%' cy='20%'>
        <stop offset='0%' stop-color='${color1}'/>
        <stop offset='100%' stop-color='${color2}'/>
      </radialGradient>
      <filter id='glow'><feGaussianBlur stdDeviation='6' result='b'/><feMerge><feMergeNode in='b'/><feMergeNode in='SourceGraphic'/></feMerge></filter>
    </defs>
    <rect width='100%' height='100%' fill='none'/>
    <g transform='translate(0,12)'>
      <ellipse cx='128' cy='170' rx='72' ry='22' fill='rgba(0,0,0,0.25)'/>
      <path d='M128 28 C188 28 220 98 220 148 C220 186 180 216 128 216 C76 216 36 186 36 148 C36 98 68 28 128 28 Z' fill='url(#g)' stroke='${accent}' stroke-opacity='0.14' stroke-width='4' filter='url(#glow)'/>
      <ellipse cx='110' cy='90' rx='28' ry='14' fill='rgba(255,255,255,0.14)' transform='rotate(-20 110 90)'/>
      <g transform='translate(132,60) rotate(-18)'>
        <ellipse cx='0' cy='0' rx='20' ry='8' fill='rgba(255,255,255,0.06)'/>
      </g>
    </g>
  </svg>`;
  return "data:image/svg+xml;utf8," + encodeURIComponent(svg);
}

function makeDetailedPetSVG(species, rarity){
  // palette varies with rarity
  const palettes = [
    ['#dfe8ff','#9aa8ff'],
    ['#c9fff7','#78e7ff'],
    ['#fff0d6','#ffb08a'],
    ['#fff6d6','#ffd06b'],
    ['#ffdff6','#ffb0ff'],
    ['#d7fff7','#aaf8f0']
  ];
  const p = palettes[Math.min(rarity, palettes.length-1)];
  const accent = (rarity>=4)? '#ffd06b' : '#ffffff';
  // more ornament for higher rarities
  const crown = (rarity>=3) ? `<rect x="80" y="8" width="40" height="10" rx="4" fill="${accent}" opacity="0.12"/>` : '';
  const face = `<circle cx='78' cy='102' r='8' fill='#111' /><circle cx='122' cy='102' r='8' fill='#111'/>`;
  const mane = (species.toLowerCase().includes('lion') || species.toLowerCase().includes('griffin'))? `<path d='M40 70 C60 40 140 40 160 70 C140 60 60 60 40 70 Z' fill='rgba(255,180,80,0.12)'/>` : '';
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'>
    <defs>
      <radialGradient id='pg' cx='30%' cy='25%'>
        <stop offset='0%' stop-color='${p[0]}'/><stop offset='100%' stop-color='${p[1]}'/>
      </radialGradient>
      <filter id='glo'><feGaussianBlur stdDeviation='6' result='b'/><feMerge><feMergeNode in='b'/><feMergeNode in='SourceGraphic'/></feMerge></filter>
    </defs>
    <rect width='100%' height='100%' fill='none'/>
    <g transform='translate(0,0)'>
      <ellipse cx='100' cy='110' rx='62' ry='46' fill='url(#pg)' stroke='rgba(0,0,0,0.12)' stroke-width='2'/>
      ${mane}
      ${face}
      <path d='M92 122 Q100 130 108 122' stroke='#111' stroke-width='3' fill='none' stroke-linecap='round'/>
      ${crown}
      ${rarity>=5? `<g transform="translate(160,30)"><circle r="14" fill="#fff" opacity="0.06"/></g>` : ''}
      <text x="100" y="180" font-family="Arial" font-size="10" text-anchor="middle" fill="rgba(255,255,255,0.18)">${species}</text>
    </g>
  </svg>`;
  return "data:image/svg+xml;utf8," + encodeURIComponent(svg);
}

/* Species pools (expanded) */
const SPECIES = [
  ["Cat","Dog","Rabbit","Bird","Mouse","Hamster","Squirrel","Fish","Frog","Turtle"],
  ["Fox","Raccoon","Owl","Fennec","Weasel","Hedgehog"],
  ["Tiger","Panther","Wolf","Badger","Lynx","Boar"],
  ["Lion","Griffin","Bear","Elephant","Rhino"],
  ["Phoenix","Hydra","Wyvern","Kraken"],
  ["VoidDrake","CosmicLion","EclipseWyrm","StarSeraph"]
];

/* egg curves */
const EGG_CURVES = {
  cheap:  [70,20,8,1.5,0.45,0.05],
  rare:   [40,30,20,7,2.7,0.3],
  epic:   [20,25,30,15,8,2],
  cosmic: [5,10,20,30,25,10]
};

/* eggs with svg icons */
const EGGS = [
  {id:'cheap', price:100, base:0.03, curve:EGG_CURVES.cheap, svg: eggSVGDataURI('#dfe8ff','#9aa8ff','#7c86ff'), label:'Cheap'},
  {id:'rare', price:1000, base:0.06, curve:EGG_CURVES.rare, svg: eggSVGDataURI('#dffcf8','#9fe2ff','#4fc3ff'), label:'Rare'},
  {id:'epic', price:10000, base:0.12, curve:EGG_CURVES.epic, svg: eggSVGDataURI('#fff1d6','#ffd18d','#ffb86b'), label:'Epic'},
  {id:'cosmic', price:100000, base:0.25, curve:EGG_CURVES.cosmic, svg: eggSVGDataURI('#f2e1ff','#ffd1ff','#ffb4ff'), label:'Cosmic'}
];

const BOOSTERS = [
  {id:'b2', label:'x2 –¥–æ—Ö–æ–¥', price:2000, secs:30, mult:2},
  {id:'b5', label:'x5 –¥–æ—Ö–æ–¥', price:5000, secs:15, mult:5},
  {id:'luck10', label:'+10 —É–¥–∞—á–∏', price:3000, secs:20, mult:'luck'}
];

const RAR_MULTI = [1,5,25,150,1000,10000];

/* ============================
   State & persistence
   ============================ */
let State = {
  money:500,
  luck:0,
  luckCost:500,
  pets:[], // array of pet objects {id,species,rarity,inc,uri,label}
  discovered:{}, // key 'rarity:species' => true
  boost:1,
  boostEnd:0,
  soundOn:true,
  volume:0.6,
  history:[]
};

function load(){
  try{
    const s = localStorage.getItem(SAVE_KEY);
    if(s) Object.assign(State, JSON.parse(s));
  }catch(e){}
}
function save(){ localStorage.setItem(SAVE_KEY, JSON.stringify(State)); }

/* ============================
   Audio (WebAudio) + unlock
   ============================ */
let audioCtx=null, masterGain=null, sfxGain=null, bgmOscs=[];
let unlocked = false;
function initAudio(){
  if(audioCtx) return;
  try{
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain(); masterGain.gain.value = State.volume;
    sfxGain = audioCtx.createGain(); sfxGain.gain.value = 1.0;
    masterGain.connect(audioCtx.destination); sfxGain.connect(masterGain);

    // ambient gentle pad (two oscillators)
    const o1 = audioCtx.createOscillator(); o1.type='sine'; o1.frequency.value=110;
    const o2 = audioCtx.createOscillator(); o2.type='sine'; o2.frequency.value=112;
    const padGain = audioCtx.createGain(); padGain.gain.value=0.0008;
    o1.connect(padGain); o2.connect(padGain); padGain.connect(masterGain);
    const lfo = audioCtx.createOscillator(); lfo.frequency.value = 0.05;
    const lfoGain = audioCtx.createGain(); lfoGain.gain.value = 0.0006; lfo.connect(lfoGain); lfoGain.connect(padGain.gain);
    o1.start(); o2.start(); lfo.start();
    bgmOscs = [o1,o2,lfo];

    window.sfxPlay = function(kind='open'){
      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.connect(g); g.connect(sfxGain);
      if(kind==='rare'){ osc.type='sawtooth'; osc.frequency.setValueAtTime(1100,now); g.gain.setValueAtTime(0.0,now); g.gain.linearRampToValueAtTime(0.9,now+0.01); osc.frequency.exponentialRampToValueAtTime(220,now+0.7); }
      else { osc.type='square'; osc.frequency.setValueAtTime(660,now); g.gain.setValueAtTime(0.0,now); g.gain.linearRampToValueAtTime(0.6,now+0.01); osc.frequency.exponentialRampToValueAtTime(220,now+0.45); }
      setTimeout(()=>{ try{ g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+0.15) }catch(e){} }, 10);
      osc.start(); setTimeout(()=>{ try{ osc.stop() }catch(e){} }, 900);
    };
  }catch(e){ console.warn('audio init failed', e); }
}
function unlockAudioAndHaptics(){
  if(unlocked) return;
  unlocked = true;
  initAudio();
  if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
  if(State.soundOn && window.sfxPlay) sfxPlay('open');
  if(navigator.vibrate) navigator.vibrate(10);
}

/* ============================
   Core game functions
   ============================ */
function rollFromCurve(curve){
  const r = Math.random()*100;
  let sum = 0;
  for(let i=0;i<curve.length;i++){ sum += curve[i]; if(r <= sum) return i; }
  return curve.length-1;
}
function pickSpecies(rarity){
  const pool = SPECIES[rarity] || ['Pet'];
  for(const s of pool){
    const key = `${rarity}:${s}`;
    if(!State.discovered[key]) return s;
  }
  // fallback variant
  return pool[Math.floor(Math.random()*pool.length)] + ' #' + (1 + Math.floor(Math.random()*99));
}
function createPet(rarity){
  const species = pickSpecies(rarity);
  const uri = makeDetailedPetSVG(species, rarity);
  const inc = RAR_MULTI[rarity] * (0.02); // adjusted scale
  const id = Date.now() + '_' + Math.floor(Math.random()*9999);
  State.discovered[`${rarity}:${species}`] = true;
  return {id,species,rarity,inc,uri,label:species};
}

/* purchase egg */
function buyEggByIndex(idx){
  const egg = EGGS[idx];
  if(State.money < egg.price){ alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç'); return; }
  State.money -= egg.price;
  // animate & open
  showEggOpenAnimation(egg, idx);
  save(); refreshHUD();
}

/* show open animation + spawn pet */
function showEggOpenAnimation(egg, idx){
  unlockAudioAndHaptics();
  // set center coin to egg
  const coinImg = document.getElementById('coinImg');
  coinImg.src = egg.svg;
  coinImg.style.transform = 'scale(0.9)';
  if(State.soundOn && unlocked && window.sfxPlay) sfxPlay('open');
  if(navigator.vibrate) navigator.vibrate(20);
  setTimeout(()=>{
    coinImg.style.transform = '';
    // particles
    spawnParticles(egg, idx);
    const rarity = rollFromCurve(egg.curve);
    const pet = createPet(rarity);
    State.pets.push(pet);
    lastDropDisplay(pet);
    // rare feedback
    if(rarity>=3){
      if(State.soundOn && unlocked && window.sfxPlay) sfxPlay('rare');
      if(navigator.vibrate) navigator.vibrate([30,20,50]);
    }
    save(); renderGalleryPreview(); refreshHUD();
  },420);
}

function spawnParticles(egg, idx){
  const layer = document.getElementById('animLayer');
  for(let i=0;i<24;i++){
    const p = document.createElement('div');
    p.className = 'particle';
    p.style.position = 'absolute';
    p.style.left = '50%'; p.style.top = '44%';
    const angle = Math.random()*Math.PI*2;
    const dist = 60 + Math.random()*140;
    const x = Math.cos(angle)*dist; const y = Math.sin(angle)*(dist*0.6) - 30;
    p.style.setProperty('--x', x + 'px'); p.style.setProperty('--y', y + 'px');
    p.style.width = (6 + Math.random()*10) + 'px'; p.style.height = p.style.width;
    p.style.borderRadius = '50%';
    const hue = (idx*80 + Math.random()*80) % 360;
    p.style.background = `hsl(${hue},80%,65%)`; p.style.opacity = 0.95;
    p.style.transition = 'transform 900ms ease-out, opacity 900ms linear';
    layer.appendChild(p);
    // animate using transform
    requestAnimationFrame(()=>{ p.style.transform = `translate(${x}px, ${y}px) scale(0.5)`; p.style.opacity = 0; });
    setTimeout(()=>{ try{ p.remove() }catch(e){} }, 1000);
  }
}

/* booster purchase */
function buyBooster(id){
  const b = BOOSTERS.find(x=>x.id===id); if(!b) return;
  if(State.money < b.price){ alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç'); return; }
  State.money -= b.price;
  if(b.mult === 'luck'){ State.luck += 10; setTimeout(()=>{ State.luck = Math.max(0, State.luck-10); save(); }, b.secs*1000); }
  else { State.boost = b.mult; State.boostEnd = Date.now() + b.secs*1000; }
  if(State.soundOn && unlocked && window.sfxPlay) sfxPlay('open');
  save(); refreshHUD();
}

/* buy luck upgrade */
function buyLuck(){
  if(State.money < State.luckCost){ alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç'); return; }
  State.money -= State.luckCost;
  State.luck++;
  State.luckCost = Math.ceil((State.luckCost || 500) * 1.7);
  if(State.soundOn && unlocked && window.sfxPlay) sfxPlay('open');
  save(); refreshHUD();
}

/* export/import progress */
function exportProgress(){
  const blob = new Blob([JSON.stringify(State)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'pet-eggs-save.json'; document.body.appendChild(a); a.click();
  a.remove(); URL.revokeObjectURL(url);
}
function importProgressFile(file){
  const reader = new FileReader();
  reader.onload = e => {
    try{
      const parsed = JSON.parse(e.target.result);
      if(parsed) { State = parsed; save(); hydratePets(); refreshHUD(); alert('–ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω'); }
    }catch(err){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–∞–π–ª'); }
  };
  reader.readAsText(file);
}

/* helper: hydrate older pets */
function hydratePets(){
  for(const p of State.pets){
    if(!p.uri) p.uri = makeDetailedPetSVG(p.species || ('Pet'+p.rarity), p.rarity);
  }
}

/* analytics chart */
function drawSmallChart(canvas, dataArr){
  const c = canvas; const ctx = c.getContext('2d');
  c.width = c.clientWidth; c.height = 160;
  ctx.clearRect(0,0,c.width,c.height);
  if(!dataArr || dataArr.length<2) return;
  const max = Math.max(...dataArr);
  ctx.strokeStyle = '#7c86ff'; ctx.lineWidth = 2; ctx.beginPath();
  for(let i=0;i<dataArr.length;i++){
    const x = (i/(dataArr.length-1 || 1))*c.width;
    const y = c.height - (dataArr[i]/max)*(c.height*0.85) - 10;
    if(i==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();
}

/* gallery rendering */
function renderGallery(){
  const list = [];
  for(const key in State.discovered){
    const [r, species] = key.split(':'); const rarity = parseInt(r);
    // pick representative pet from State.pets
    const p = State.pets.find(x => x.species === species && x.rarity === rarity);
    if(p) list.push(p);
  }
  list.sort((a,b)=>a.rarity - b.rarity);
  const galleryListEl = document.getElementById('galleryList');
  galleryListEl.innerHTML = '';
  for(const pet of list){
    const tile = document.createElement('div'); tile.className = 'galleryTile';
    const petBox = document.createElement('div'); petBox.className='pet3d';
    if(pet.rarity >= 3) petBox.classList.add('glowGold');
    petBox.innerHTML = `<img src="${pet.uri}" style="width:84px;height:84px;border-radius:10px"/>`;
    const info = document.createElement('div'); info.style.flex='1';
    info.innerHTML = `<div style="font-weight:700">${pet.label}</div><div style="opacity:.8">${["Common","Rare","Epic","Legendary","MYTHIC","COSMIC"][pet.rarity]}</div>`;
    tile.appendChild(petBox); tile.appendChild(info);
    galleryListEl.appendChild(tile);
  }
}

/* achievements */
const ACHIEVEMENTS = [
  {id:'first', title:'–ü–µ—Ä–≤—ã–π –ø–∏—Ç–æ–º–µ—Ü', check:()=>Object.keys(State.discovered).length>=1},
  {id:'collector10', title:'–ö–æ–ª–ª–µ–∫—Ç–æ—Ä 10', check:()=>Object.keys(State.discovered).length>=10},
  {id:'reach1k', title:'1k –º–æ–Ω–µ—Ç', check:()=>State.money>=1000}
];
function checkAchievements(){
  let changed=false;
  for(const a of ACHIEVEMENTS){
    if(a.check() && !State[a.id]){ State[a.id] = true; changed = true; }
  }
  if(changed) save();
}

/* helper display last drop */
function lastDropDisplay(pet){
  document.getElementById('lastDrop').innerText = `üêæ –ü–æ—Å–ª–µ–¥–Ω–∏–π: ${pet.label} (${["Common","Rare","Epic","Legendary","MYTHIC","COSMIC"][pet.rarity]})`;
}

/* HUD refresh */
function refreshHUD(){
  document.getElementById('moneyDisplay').innerText = 'üí∞ ' + fmt(State.money || 0);
  const totalPS = (State.pets||[]).reduce((s,p)=>s+p.inc, 0) * ( (Date.now() < State.boostEnd) ? State.boost : 1 );
  document.getElementById('perSec').innerText = '‚ö° ' + fmt(totalPS) + ' / —Å–µ–∫';
  document.getElementById('luckInfo').innerText = `üçÄ –£–¥–∞—á–∞: ${State.luck}`;
  document.getElementById('luckPrice').innerText = fmt(State.luckCost || 500);
  // booster timer
  if(Date.now() < State.boostEnd){ document.getElementById('boosterTimer').innerText = `–ë—É—Å—Ç–µ—Ä x${State.boost} ‚Äî ${Math.ceil((State.boostEnd-Date.now())/1000)}—Å`; }
  else document.getElementById('boosterTimer').innerText = '';
  save();
  checkAchievements();
  renderGalleryPreview();
}

/* render egg select & lists */
function renderEggsUI(){
  const sel = document.getElementById('eggSelect'); sel.innerHTML='';
  EGGS.forEach((e, i)=>{
    const opt = document.createElement('option'); opt.value=i; opt.innerText = `${e.label} ‚Äî ${fmt(e.price)}`;
    sel.appendChild(opt);
  });
  // quick eggs
  const quick = document.getElementById('quickEggs'); quick.innerHTML='';
  EGGS.forEach((e,i)=>{
    const btn = document.createElement('button'); btn.className='buyBtn'; btn.style.display='block'; btn.style.marginBottom='8px';
    btn.innerText = `${e.label} ‚Äî ${fmt(e.price)} ‚Äî –ö—É–ø–∏—Ç—å`; btn.onclick = ()=>buyEggByIndex(i);
    quick.appendChild(btn);
  });
}

/* render shop boosters list */
function renderShopList(){
  const list = document.getElementById('shopList'); list.innerHTML='';
  BOOSTERS.forEach(b=>{
    const div = document.createElement('div'); div.className='stat';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>${b.label}</strong><div style="font-size:12px;opacity:.8">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${b.secs}s</div></div>
      <div style="text-align:right"><div class="priceAbbr">${fmt(b.price)}</div><button class="buyBtn" style="margin-top:8px" onclick="buyBooster('${b.id}')">–ö—É–ø–∏—Ç—å</button></div>
    </div>`;
    list.appendChild(div);
  });
}

/* gallery preview */
function renderGalleryPreview(){
  const keys = Object.keys(State.discovered);
  let html = '';
  for(const k of keys.slice(0,6)){ const sp = k.split(':')[1]; html += `<span style="display:inline-block;padding:6px;border-radius:6px;margin-right:6px;background:rgba(255,255,255,0.02)">${sp}</span>`; }
  document.getElementById('achPreview').innerHTML = html || '<div style="opacity:.7">–ü–æ–∫–∞ –Ω–µ—Ç –ø–∏—Ç–æ–º—Ü–µ–≤</div>';
}

/* ============================
   Interactions, events init
   ============================ */
load(); hydratePets(); initAudio(); renderEggsUI(); renderShopList(); renderGalleryPreview(); refreshHUD();

/* unlock audio on first tap */
document.addEventListener('click', function once(){ unlockAudioAndHaptics(); document.removeEventListener('click', once); });

document.getElementById('buyEggBtn').onclick = ()=>{ const i = parseInt(document.getElementById('eggSelect').value||0); buyEggByIndex(i); };
document.getElementById('buyLuckBtn').onclick = buyLuck;
document.getElementById('btnSettings').onclick = ()=>{ document.getElementById('settingsModal').style.display='flex'; document.getElementById('volumeRange').value = State.volume; };
document.getElementById('closeSettings').onclick = ()=>{ document.getElementById('settingsModal').style.display='none'; };
document.getElementById('btnGallery').onclick = ()=>{ renderGallery(); document.getElementById('galleryModal').style.display='flex'; };
document.getElementById('closeGallery').onclick = ()=>{ document.getElementById('galleryModal').style.display='none'; };
document.getElementById('btnAnalytics').onclick = ()=>{ document.getElementById('analyticsModal').style.display='flex'; drawSmallChart(document.getElementById('chartModal'), State.history); document.getElementById('statsBlock').innerHTML = `<div>–ú–æ–Ω–µ—Ç: ${fmt(State.money)}</div><div>–ü–∏—Ç–æ–º—Ü–µ–≤: ${State.pets.length}</div>`; };
document.getElementById('closeAnalytics').onclick = ()=>{ document.getElementById('analyticsModal').style.display='none'; };

document.getElementById('exportBtn').onclick = exportProgress;
document.getElementById('importBtn').onclick = ()=>{ document.getElementById('importFile').click(); };
document.getElementById('importFile').onchange = function(e){ const f = e.target.files[0]; if(f) importProgressFile(f); };

document.getElementById('volumeRange').oninput = function(){ State.volume = parseFloat(this.value); if(masterGain) masterGain.gain.value = State.volume; save(); };
document.getElementById('toggleSound').onclick = function(){ State.soundOn = !State.soundOn; this.innerText = State.soundOn ? '–ó–≤—É–∫: –í–∫–ª' : '–ó–≤—É–∫: –í—ã–∫–ª'; save(); };

document.getElementById('btnAnalytics').addEventListener('touchstart', ()=>{ unlockAudioAndHaptics(); }, {once:true});
document.getElementById('btnGallery').addEventListener('touchstart', ()=>{ unlockAudioAndHaptics(); }, {once:true});

/* periodic ticks */
setInterval(()=>{
  // income tick
  let inc = 0; for(const p of State.pets) inc += p.inc;
  const mult = (Date.now() < State.boostEnd) ? State.boost : 1;
  State.money += inc * mult;
  // history
  State.history.push(State.money);
  if(State.history.length > 40) State.history.shift();
  refreshHUD();
}, 1000);

/* chart update */
setInterval(()=>{ drawSmallChart(document.getElementById('chart'), State.history); }, 4000);

/* gallery preview / achievements refresh */
setInterval(()=>{ renderGalleryPreview(); checkAchievements(); }, 3000);

/* quick click on center coin spawns small particle burst & unlock */
document.getElementById('coinWrap').addEventListener('click', function(){
  unlockAudioAndHaptics();
  for(let i=0;i<12;i++){
    const p = document.createElement('div'); p.className='particle';
    const layer = document.getElementById('animLayer');
    p.style.left = (50 + (Math.random()-0.5)*20) + '%';
    p.style.top  = (50 + (Math.random()-0.5)*8) + '%';
    const x = (Math.random()-0.5)*140, y = - (80 + Math.random()*120);
    p.style.setProperty('--x', x + 'px'); p.style.setProperty('--y', y + 'px');
    p.style.width = (6 + Math.random()*12) + 'px'; p.style.height = p.style.width;
    p.style.borderRadius = '50%'; p.style.background = `hsl(${Math.random()*360},80%,65%)`;
    layer.appendChild(p); setTimeout(()=>p.remove(),1200);
  }
});

/* initial coin image */
(function(){ const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><defs><radialGradient id='c' cx='30%' cy='30%'><stop offset='0%' stop-color='#fff6d0'/><stop offset='100%' stop-color='#ffd06b'/></radialGradient></defs><circle cx='100' cy='100' r='80' fill='url(#c)' stroke='#ffd06b' stroke-width='6'/><text x='100' y='115' font-size='54' text-anchor='middle' font-family='Arial' fill='#b36f00' font-weight='700'>‚Çµ</text></svg>`; document.getElementById('coinImg').src = "data:image/svg+xml;utf8," + encodeURIComponent(svg); })();

/* initial UI fill */
function initAllUI(){
  renderEggsUI(); renderShopList(); renderGalleryPreview(); refreshHUD();
}
initAllUI();

/* helper to hydrate older saves */
function hydratePets(){
  for(const p of State.pets){
    if(!p.uri) p.uri = makeDetailedPetSVG(p.species || ('Pet'+p.rarity), p.rarity);
  }
}

/* register service worker (if present) */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/sw.js').then(()=>{ console.log('SW registered'); }).catch(e=>{ console.warn('SW failed', e); });
}

</script>
</body>
</html>